const mysql = require('mysql');
const express = require('express');
const session = require('express-session');
const path = require('path');
/*const db_queries = require('./js/db_queries.js');*/

const connection = mysql.createConnection({
	host: 'localhost',
	user: 'root',
	password: 'Hitchhikers1431997!',
	database: 'lms_db'
});

const app = express();

app.set('view engine', 'ejs');

app.use(session({
	secret: 'secret',
	resave: true,
	saveUninitialized: true
}));

app.use(express.json());

app.use(express.urlencoded({ extended: true }));

app.use(express.static(path.join(__dirname, '')));

app.get('/', function(request, response) {
	response.sendFile(path.join(__dirname + '/SignIn.html'));
});

app.post('/auth', function(request, response) {
	// Capture the input fields
	let email = request.body.EmailIn;
	let password = request.body.PasswordIn;
	let accountType = request.body.AccountIn;
	// Ensure the input fields exists and are not empty
	if (email && password && accountType == "member") {
		// Execute SQL query that'll select the account from the database based on the specified email and password
		connection.query('SELECT * FROM members LEFT JOIN users ON members.user_id = users.user_id WHERE email = ? AND password = ?', [email, password], function(error, results, fields) {
			// If there is an issue with the query, output the error
			if (error) throw error;
			// If the account exists
			if (results.length > 0) {
				// Authenticate the user
				request.session.loggedin = true;
				request.session.email = email;
				// Redirect to home page
				response.redirect('/HomePage');
			} else {
				response.send('Incorrect Email and/or Password!');
			}			
			response.end();
		});
	} else {
		response.send('Please enter Email and Password and Account Type!');
		response.end();
	}
});

app.get('/', (request, response) => {
	// If the user is loggedin
	if (request.session.loggedin) {
		// Output email
		//response.send('Welcome back, ' + request.session.email + '!');
		response.render("HomePage", {
			
		})
	} else {
		// Not logged in
		response.send('Please login to view this page!');
	}
	response.end();
});

/*connection.connect(function(err) {
	if (err) throw err;
	console.log("Connected!");
	connection.query("SELECT title FROM books", function(err, result, field) {
		if(!err) {
			let grid = document.getElementById("#libraryBookGrid");
			while(grid.firstChild) {
				grid.removeChild(grid.firstChild);
			}
			for(let i = 0; i < result.length; i++) {
				let newDiv = document.createElement("div");
				newDiv.classList.add("bookTitle");
				let content = document.createTextNode(result[i]);
				newDiv.appendChild(content);
				grid.appendChild(newDiv);
			}
		}
		else {
			throw err;
		}
	}
)});*/

app.listen(3000);